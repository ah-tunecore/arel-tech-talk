<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Arel Tech Talk</title>

    <meta name="description" content="Overview of the Ruby Arel Library">
    <meta name="author" content="Andrew Hoglund">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/simple.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h2>Arel Tech Talk</h2>
          <h6>Refactoring SQL Queries using Arel and Query Builders</h6>
        </section>


        <section>
        <section>
          <p>What is Arel?<p>
          <q cite="https://github.com/rails/arel">
           Arel is a SQL AST manager for Ruby.
         </q>
        </section>
         <section>
          <p>What is an AST?</p>
          <q cite="https://en.wikipedia.org/wiki/Abstract_syntax_tree">
          An abstract syntax tree (AST), or just syntax tree, is a tree representation of the abstract syntactic structure of source code written in a programming language. Each node of the tree denotes a construct occurring in the source code.
          </q>
        </section>
       </section>
       <section>
        <h3>Arel will:</h3>
         <ol>
          <li>Simplify the generation of complex SQL queries</li>
          <li>Adapt to various RDBMSes</li>
         </ol>
       </section>
       <section>
        <p>More about Arel</p>
        <q cite="https://github.com/rails/arel">
        It is intended to be a framework framework; that is, you can build your own ORM with it, focusing on innovative object and collection modeling as opposed to database compatibility and query generation.
          </q>
          <br />
          <br />
          <p>Case in point:</p>
          <p>ActiveRecord is built with Arel.</p>
        </section>
        <section>
          <p>Let's look at some code</p>
        </section>
        <section>
        <p>A Custom SQL We need to get into code.</p>
        <pre><code class="hljs" data-trim contenteditable>
SELECT d.* FROM distributions d
INNER JOIN distributions_salepoints ds ON ds.distribution_id = d.id
INNER JOIN salepoints s ON s.id = ds.salepoint_id
INNER JOIN petri_bundles pb ON pb.id = d.petri_bundle_id
INNER JOIN albums a ON a.id = pb.album_id
INNER JOIN upcs u ON u.upcable_id = a.id AND u.upcable_type = 'Album'
WHERE d.converter_class = 'MusicStores::Itunes::Converter'
AND s.store_id = 1
AND u.number IN (859709356761,859709363271)
ORDER BY d.id;
        </code></pre>
        </section>
        <section>
          <p>The cheap and easy way</p>
          <pre><code class="hljs" data-trim contenteditable>
Distribution.find_by_sql("
SELECT d.* FROM distributions d
INNER JOIN distributions_salepoints ds ON ds.distribution_id = d.id
INNER JOIN salepoints s ON s.id = ds.salepoint_id
INNER JOIN petri_bundles pb ON pb.id = d.petri_bundle_id
INNER JOIN albums a ON a.id = pb.album_id
INNER JOIN upcs u ON u.upcable_id = a.id AND u.upcable_type = 'Album'
WHERE d.converter_class = 'MusicStores::Itunes::Converter'
AND s.store_id = 1
AND u.number IN (859709356761,859709363271)
ORDER BY d.id;")
          </code></pre>
        </section>
        <section>
          <p>What is wrong with this code?</p>
          <ol>
            <li>Not abstracted from database</li>
            <li>Not object oriented</li>
            <li>Not possible to have this syntax checked</li>
            <li>Not actually ruby code. It's just embedded SQL code hiding in your ruby.</li>
            <li>Not reusable (unless you define reusable as copy/paste)</li>
          </ol>
        </section>
        <section>
          <p>So how can we make this better.</p>
        </section>
        <section>
          <p>Using some AR methods</p>
          <pre><code class="hljs" data-trim contenteditable>
Distribution
  .select("distributions.*")
  .joins("
           INNER JOIN distributions_salepoints ds ON ds.distribution_id = distributions.id
           INNER JOIN salepoints s ON s.id = ds.salepoint_id
           INNER JOIN petri_bundles pb ON pb.id = distributions.petri_bundle_id
           INNER JOIN albums a ON a.id = pb.album_id
           INNER JOIN upcs u ON u.upcable_id = a.id AND u.upcable_type = 'Album'
        ")
  .where("
           distributions.converter_class = 'MusicStores::Itunes::Converter'
           AND s.store_id = 1
           AND u.number IN (859709356761)
        ")
          </code></pre>
        </section>
        <section>
          <p>Not much better since its still just embedding SQL into our method calls</p>
          <p>Is there a way we can write this query using purely <strong>Ruby</strong> code?</p>
        </section>
        <section>
          <section>
            <p>Let's use Arel to compose this query.</p>
          </section>
          <section>
            <p>A sidebar about the arel_table method</p>
            <p><pre><code>Model.arel_table</code></pre></p>
            <pre><code class="hljs" data-trim contenteditable>
distribution = Distribution.arel_table
  => Arel::Table:0x007f9d0dcbdf48
            </code></pre>
            <ol>
              <li>Available on all ActiveRecord models.</li>
              <li>Returns an Arel::Table instance of the model</li>
            </ol>
          </section>
          <section>
            <p>We can access model attributes using Hash-like methods</p>
            <pre><code class="hljs" data-trim contenteditable>
distribution[:converter_class]
  => Arel::Attributes::Attribute
            </code></pre>

            <pre><code class="hljs" data-trim contenteditable>
distribution[Arel.star]
  => Arel::Attributes::Attribute
            </code></pre>
            <sup>**Arel.star allows you to select all attributes</sup>
          </section>
          <section>
            <p>A sidebar about the joins method</p>
            <pre><code>.joins(petri_bundle: { album: :upcs })</code></pre>
            <p>Passing joins nested hashes of the associations will let you use ActiveRecord's knowledge of the association.</p>
            <p>Example:</p>
            <pre><code class="hljs" data-trim contenteditable>
Distribution.joins(:salepoints, petri_bundle: { album: :upcs }).to_sql
=> "SELECT `distributions`.* FROM `distributions`
    INNER JOIN `distributions_salepoints` ON `distributions_salepoints`.`distribution_id` = `distributions`.`id`
    INNER JOIN `salepoints` ON `salepoints`.`id` = `distributions_salepoints`.`salepoint_id`
    INNER JOIN `petri_bundles` ON `petri_bundles`.`id` = `distributions`.`petri_bundle_id`
    INNER JOIN `albums` ON `albums`.`id` = `petri_bundles`.`album_id`
    INNER JOIN `upcs` ON `upcs`.`upcable_id` = `albums`.`id` AND `upcs`.`upcable_type` = 'Album'"
           </code></pre>
          </section>
        </section>
        <section>
          <p>Using Arel::Table instances to formulate our joins</p>
          <pre><code class="hljs" data-trim contenteditable>
Distribution
  .select(Distribution.arel_table[Arel.star])
  .joins(:salepoints, petri_bundle: { album: :upcs })
          </code></pre>
        </section>
        <section>
          <p>This is gonna get verbose, lets define methods to return the arel_table's we need.</p>
          <pre><code class="hljs" data-trim contenteditable>
def distribution
  Distribution.arel_table
end

def upc
  Upc.arel_table
end

def petri_bundle
  PetriBundle.arel_table
end

def salepoint
  Salepoint.arel_table
end
          </code></pre>
        </section>
        <section>
          <p>Using our new methods</p>
          <pre><code class="hljs" data-trim contenteditable>
Distribution
  .select(distribution[Arel.star])
  .joins(:salepoints, petri_bundle: { album: :upcs })
          </code></pre>
        </section>
        <section>
          <h3>Building our where clauses</h3>
          <p>Arel comes with a wide assortment of predication and expression methods we can pass to the AR where method</p>
          <p>Lets take a look at a few:<p>
           <a target="_blank" href="https://github.com/rails/arel/blob/master/lib/arel/predications.rb">Arel Predication Source</a> <br />
           <a target="_blank" href="https://github.com/rails/arel/blob/master/lib/arel/expressions.rb">Arel Expression Source</a>
        </section>
        <section>
          <p>Using these on our where</p>
          <pre><code class="hljs" data-trim contenteditable>
where(distribution[:converter_class].eq(converter_class))

where(salepoint[:store_id].eq(store_id))

where(upc[:number].in(upcs))

# Performs a LIKE
where(distribution[:converter_class].matches("%#{converter_class}%"))

# Inequality
where(salepoint[:store_id].not_eq(store_id))

          </code></pre>
        </section>
        <section>
          <p>All these where clauses are chainable, so this is perfectly valid</p>
          <pre><code class="hljs" data-trim contenteditable>
where(distribution[:converter_class].eq(converter_class)).where(salepoint[:store_id].eq(store_id)).where(upc[:number].in(upcs))

# Or all passed to one where clause, chained with the .and method
.where(distribution[:converter_class].eq(converter_class).and(salepoint[:store_id].eq(store_id).and(upc[:number].in(upcs))))
          </code></pre>
        </section>
        <section>
          <p>Finishing up our new composed query</p>
          <pre><code class="hljs" data-trim contenteditable>
converter_class = "MusicStores::Itunes::Converter"
store_id = 1
upcs = [1,2,3]

Distribution
  .select(distribution[Arel.star])
  .joins(:salepoints, petri_bundle: { album: :upcs })
  .where(
          distribution[:converter_class].eq(converter_class)
        )
  .where(
           salepoint[:store_id].eq(store_id)
        )
  .where(
          # Note that i can pass an array to the in method
          upc[:number].in(upcs)
        )
          </code></pre>
        </section>
        <section>
          <p>Putting this in an object that can be reused.</p>
          <ul>
            <li>There are many ways to implement a query building object.</li>
            <li>One option: Use reflector methods to be able to chain methods off the instance. <a target="_blank" href="https://github.com/tunecore/tc-www/blob/master/app/models/distribution/distribution_retry_query_builder.rb">Example</a></li>
            <li>Another option: Use a factory/builder pattern to be able to pass in a hash of options that will build the query for you.</li>
          </ul>
        </section>
        <section>
          <p>Some other things you can do with Arel.</p>
          <ul>
            <li>String together or and and methods</li>
            <li>Pass objects to the joins methods that represent OUTER, FULL OUTER, RIGHT OUTER, etc.. joins</li>
            <li>You can even define NameFunctions for DB specific methods like COALESCE</li>
            <li>Perform nested selects</li>
            <li>NOTE: Arel documentation is scarce so best bet is to read some source code.</li>
          </ul>
        </section>
        <section>
          <h3>Summary</h3>
          <ul>
            <li>Extracted Raw SQL out of our code</li>
            <li>We now get syntax checking for free, since its just ruby</li>
            <li>Can be used on an DB</li>
            <li>Object oriented</li>
            <li>As demonstrated, can be using to build reuable query builder objects</li>
            <li>Got a lot of this information from <a target="_blank" href="https://www.youtube.com/watch?v=ShPAxNcLm3o">this talk.</a></li>
          </ul>
        </section>
        <section>
          <p>End</p>
        </section>
      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
